{% extends 'base.html.twig' %}

{% block title %}Instrument - {{ instruments.numSerie }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* --- STYLES EXISTANTS (Conservés) --- */
        .show-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .page-header { margin-bottom: 30px; border-bottom: 2px solid var(--color-primary-accent); padding-bottom: 10px; color: #2c3e50; font-size: 1.8rem; display: flex; align-items: center; gap: 15px; }
        .details-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; margin-bottom: 25px; }
        @media (max-width: 768px) { .details-grid { grid-template-columns: 1fr; } }
        .info-card { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 20px; border-left: 5px solid var(--color-primary-accent); height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .image-container { text-align: center; display: flex; align-items: center; justify-content: center; background-color: #fff; min-height: 200px; }
        .instrument-img { max-width: 100%; max-height: 250px; border-radius: 6px; object-fit: contain; transition: transform 0.3s ease; }
        .instrument-img:hover { transform: scale(1.03); }
        .info-group { margin-bottom: 15px; }
        .info-group:last-child { margin-bottom: 0; }
        .label { font-size: 0.8rem; text-transform: uppercase; color: #7f8c8d; font-weight: 700; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        .value { font-size: 1.2rem; color: #2c3e50; font-weight: 600; }
        .full-width-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-top: 25px; }
        .list-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .chip { background-color: var(--color-primary-accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .actions-bar { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .actions-bar form { margin: 0; }

        /* --- NOUVEAUX STYLES POUR LA DISPONIBILITÉ --- */
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
        }
        .status-available { background-color: #27ae60; } /* Vert */
        .status-loaned { background-color: #e67e22; }    /* Orange */

        /* --- STYLE TABLEAU HISTORIQUE --- */
        .history-section { margin-top: 40px; }
        .history-title { font-size: 1.4rem; color: #2c3e50; margin-bottom: 15px; border-left: 4px solid #34495e; padding-left: 10px; }
        
        .history-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .history-table th { background-color: #34495e; color: white; padding: 12px; text-align: left; font-size: 0.9rem; }
        .history-table td { padding: 12px; border-bottom: 1px solid #eee; color: #555; font-size: 0.95rem; }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table tr:hover { background-color: #f8f9fa; }
        
        .badge-active { background-color: #e67e22; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }
        .badge-past { background-color: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }
    </style>
{% endblock %}

{% block body %}

{# --- LOGIQUE DE DÉTECTION DU CONTRAT ACTUEL --- #}
{% set contratActuel = null %}
{# On parcourt les contrats pour voir si l'un d'eux est actif aujourd'hui #}
{% for contrat in instruments.contratsPret %}
    {% set today = date() %}
    {% if today >= date(contrat.dateDebut) and today <= date(contrat.dateFin) %}
        {% set contratActuel = contrat %}
    {% endif %}
{% endfor %}

<div class="show-container">
    
    {# TITRE #}
    <div class="page-header">
        <i class="fa-solid fa-guitar fa-lg" style="color: var(--color-primary-accent);"></i>
        <span>Détails de l'Instrument #{{ instruments.id }}</span>
    </div>

    {# --- LIGNE DU HAUT : IMAGE + INFOS --- #}
    <div class="details-grid">
        
        {# CARTE IMAGE #}
        <div class="info-card">
            {# BADGE DE STATUT (NOUVEAU) #}
            {% if contratActuel %}
                <div class="status-badge status-loaned">
                    <i class="fa-solid fa-clock"></i> ACTUELLEMENT LOUÉ
                </div>
            {% else %}
                <div class="status-badge status-available">
                    <i class="fa-solid fa-check-circle"></i> DISPONIBLE
                </div>
            {% endif %}

            <div class="image-container">
                <img src="{{ asset('img/instruments/' ~ instruments.id ~ '.jpg') }}" 
                     class="instrument-img"
                     alt="Instrument {{ instruments.numSerie }}"
                     onerror="this.onerror=null; this.src='{{ asset('img/instruments/default.jpg') }}'; this.alt='Image non disponible';"
                >
            </div>
        </div>

        {# CARTE INFOS GÉNÉRALES #}
        <div class="info-card">
            
            {# SI LOUÉ : AFFICHER LES INFOS DU LOCATAIRE EN PREMIER #}
            {% if contratActuel %}
                <div style="background-color: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffeeba; margin-bottom: 20px;">
                    <span class="label" style="color: #856404;"><i class="fa-solid fa-user"></i> Actuellement chez :</span>
                    <div style="font-size: 1.1rem; font-weight: bold; color: #856404;">
                        {{ contratActuel.eleve.prenom }} {{ contratActuel.eleve.nom }}
                    </div>
                    <div style="font-size: 0.9rem; color: #856404; margin-top: 5px;">
                        Jusqu'au : {{ contratActuel.dateFin|date('d/m/Y') }}
                    </div>
                    <a href="{{ path('app_contrat_pret_show', {'id': contratActuel.id}) }}" style="font-size: 0.85rem; text-decoration: underline; color: #856404;">
                        Voir le contrat
                    </a>
                </div>
            {% endif %}

            <div class="info-group">
                <span class="label"><i class="fa-solid fa-tag"></i> Type d'instrument</span>
                <span class="value">{{ instruments.typeInstrument.libelle ?? 'Non défini' }}</span>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

            <div class="info-group">
                <span class="label"><i class="fa-solid fa-copyright"></i> Marque & Modèle</span>
                <span class="value">{{ instruments.marque.libelle ?? 'Non définie' }}</span>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

            <div class="info-group">
                <span class="label"><i class="fa-solid fa-barcode"></i> Numéro de Série</span>
                <span class="value" style="font-family: monospace; font-size: 1.3rem;">{{ instruments.numSerie }}</span>
            </div>
        </div>
    </div>

    {# --- LIGNE DU MILIEU : ACHAT & COULEURS --- #}
    <div class="full-width-section">
        <div class="info-card">
            <div class="info-group">
                <span class="label"><i class="fa-solid fa-euro-sign"></i> Informations d'Achat</span>
                <div style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">Date :</span>
                        <strong>{{ instruments.dateAchat ? instruments.dateAchat|date('d/m/Y') : '-' }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Prix :</span>
                        <strong>{{ instruments.prixAchat ? (instruments.prixAchat|number_format(2, ',', ' ') ~ ' €') : '-' }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card">
            <span class="label"><i class="fa-solid fa-palette"></i> Finitions / Couleurs</span>
            <div class="list-chips">
                {% if instruments.couleurs is not empty %}
                    {% for couleur in instruments.couleurs %}
                        <span class="chip">{{ couleur.nom }}</span>
                    {% endfor %}
                {% else %}
                    <span style="color: #ccc; font-style: italic; font-size: 0.9rem;">Aucune couleur spécifiée</span>
                {% endif %}
            </div>
        </div>
    </div>

    {# --- HISTORIQUE DES PRÊTS (NOUVEAU) --- #}
    <div class="history-section">
        <h3 class="history-title">Historique des Locations</h3>
        
        {% if instruments.contratsPret is not empty %}
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Statut</th>
                            <th>Élève</th>
                            <th>N° Contrat</th>
                            <th>Période</th>
                            <th>État Départ</th>
                            <th>État Retour</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# On trie pour avoir les plus récents en premier (si possible via contrôleur, sinon ici ordre par défaut) #}
                        {% for contrat in instruments.contratsPret|reverse %}
                            {% set isActive = (date() >= date(contrat.dateDebut) and date() <= date(contrat.dateFin)) %}
                            <tr>
                                <td>
                                    {% if isActive %}
                                        <span class="badge-active">EN COURS</span>
                                    {% else %}
                                        <span class="badge-past">TERMINÉ</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ contrat.eleve.prenom }} {{ contrat.eleve.nom }}</strong></td>
                                <td>{{ contrat.numContrat }}</td>
                                <td>
                                    Du {{ contrat.dateDebut|date('d/m/Y') }}<br>
                                    Au {{ contrat.dateFin|date('d/m/Y') }}
                                </td>
                                <td>{{ contrat.etatDetailleDebut|default('-') }}</td>
                                <td>{{ contrat.etatDetailleRetour|default('-') }}</td>
                                <td>
                                    <a href="{{ path('app_contrat_pret_show', {'id': contrat.id}) }}" class="btn-action btn-show" style="padding: 4px 8px; font-size: 0.8rem; margin:0;">
                                        <i class="fa-solid fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fa-solid fa-info-circle"></i> Cet instrument n'a jamais été loué.
            </div>
        {% endif %}
    </div>

    {# --- BOUTONS D'ACTION --- #}
    <div class="actions-bar">
        <a href="{{ path('app_instrument_index') }}" class="btn-action btn-back">
            <i class="fa-solid fa-arrow-left"></i> Retour liste
        </a>

        <a href="{{ path('app_instrument_edit', {'id': instruments.id}) }}" class="btn-action btn-edit">
            <i class="fa-solid fa-pen-to-square"></i> Modifier
        </a>

        {{ include('instrument/_delete_form.html.twig') }}
    </div>

</div>
{% endblock %}